
# AI 客服系统 Prompt 设计与代码更新指南

本文件描述了在 AI 客服项目中如何设计 Prompt、管理上下文以及如何存储数据以支持未来模型微调。适用于 OpenAI API 前期集成，也支持后续迁移到本地模型。

---

## 🧠 产品场景概述

- **目标**：构建一个多渠道（Telegram, WhatsApp, Line）AI客服，支持C端信用卡用户与B端代理。
- **功能亮点**：
  - 自动多语言支持（中文输入→客户看到其语言）
  - 上下文记忆和总结
  - 工单系统联动（AI无法处理或需权限时自动转人工）
  - 后期支持本地模型微调

---

## 🎯 Prompt 结构设计

### 1. **System Prompt（角色设定）**
```
你是“Lava Assistant”，一名专业信用卡和支付领域的客服专家。
- 用自然、简洁的语言回答客户问题
- 对于复杂或敏感问题，如果需要人工权限，请返回：
  {"action": "escalate", "reason": "需要人工处理"}
- 当客户语言非中文时，自动切换到对应语言回复
- 不要提及你是AI
```

---

### 2. **User Message（输入格式）**
```json
{
  "user_id": "tg_123456",
  "chat_id": "-100987654",
  "channel": "Telegram",
  "language": "ru",
  "message": "Когда я получу выписку?"
}
```

---

### 3. **Assistant Response（输出格式）**
普通回复：
```json
{
  "reply": "Ваша выписка будет готова 20 июля.",
  "confidence": 0.95
}
```

转人工：
```json
{
  "action": "escalate",
  "reason": "用户请求调整信用额度，此操作需要人工权限。"
}
```

---

## 📦 数据存储设计

### 1. **对话记录**
```json
{
  "conversation_id": "conv_00123",
  "user_id": "tg_123456",
  "role": "user",
  "message": "请问我的账单什么时候出？",
  "timestamp": "2025-07-14T12:34:56Z",
  "language": "zh"
}
```

### 2. **上下文摘要**
```json
{
  "conversation_id": "conv_00123",
  "summary": "用户多次咨询账单和额度调整。",
  "updated_at": "2025-07-14T12:40:00Z"
}
```

### 3. **人工介入标记**
```json
{
  "conversation_id": "conv_00123",
  "is_human_intervened": true,
  "assigned_agent": "agent_789",
  "started_at": "2025-07-14T12:41:00Z"
}
```

---

## 🌐 特殊逻辑

- **多语言翻译**：
  - 客服输入中文，系统调用翻译API（如OpenAI、DeepL）
  - 客户回复自动翻译为中文展示给客服

- **人工介入**：
  - AI检测到需要人工权限 → 标记 `is_human_intervened = true`
  - 后台通知人工客服
  - 人工客服通过同一Bot账号与客户对话

- **工单联动**：
  - AI无法处理 → 自动创建工单
  - 工单处理完毕 → 系统同步状态给AI/客户

---

## 🛠 Cursor 更新指令

在 Cursor 中编辑代码时，请确保：
1. 根据以上Prompt和数据结构更新API调用逻辑
2. 确保支持以下功能：
   - 多语言识别与翻译
   - 人工介入状态检测
   - 上下文加载与摘要管理
3. 输出结果格式化为 JSON 结构，便于前端或API直接使用

---

## 🔥 后续本地模型微调准备

### 必存数据
| 数据类型       | 用途                     |
|----------------|--------------------------|
| 全量对话记录   | 模型微调基础              |
| 上下文摘要     | 长对话场景优化            |
| 人工介入记录   | 训练AI识别需转人工场景     |
| 反馈评分       | RLHF或监督学习优化        |

### 推荐格式 (jsonl for finetune)
```json
{"prompt": "用户: 我什么时候会收到账单？\n客服:", "completion": "您的账单将在7月20日生成。"}
```

---

## 📌 注意事项

- 保证所有敏感数据（如用户ID、账单信息）脱敏存储
- 对翻译接口调用做缓存，减少重复翻译API调用成本
- 日志记录每次AI API调用，便于后续回溯和优化

---
