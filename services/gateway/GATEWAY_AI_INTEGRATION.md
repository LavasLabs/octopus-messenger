# Gateway AIé›†æˆå‡çº§æŒ‡å—

## ğŸ¯ å‡çº§æ¦‚è¿°

Gatewayå·²å…¨é¢é›†æˆåŒæ¨¡å¼AIåˆ†ç±»ç³»ç»Ÿï¼Œä¸ºæ‰€æœ‰å¹³å°æ¶ˆæ¯æä¾›ç»Ÿä¸€çš„æ™ºèƒ½åˆ†ç±»æœåŠ¡ã€‚

## ğŸš€ æ–°å¢åŠŸèƒ½

### âœ¨ æ™ºèƒ½æ¶ˆæ¯åˆ†ç±»
- **è‡ªåŠ¨AIåˆ†ç±»**ï¼šæ‰€æœ‰æ¶ˆæ¯è‡ªåŠ¨è¿›è¡ŒAIåˆ†ç±»
- **åŒæ¨¡å¼æ”¯æŒ**ï¼šæ ¹æ®ç§Ÿæˆ·æ¨¡å¼é€‰æ‹©åˆ†ç±»ç­–ç•¥
- **å›é€€æœºåˆ¶**ï¼šAIæœåŠ¡å¤±è´¥æ—¶è‡ªåŠ¨å›é€€åˆ°åŸºç¡€åˆ†ç±»
- **æ‰¹é‡å¤„ç†**ï¼šæ”¯æŒæ¶ˆæ¯æ‰¹é‡åˆ†ç±»

### ğŸ§  AIæœåŠ¡é›†æˆ
- **ç»Ÿä¸€å®¢æˆ·ç«¯**ï¼š`AIServiceClient`æä¾›æ ‡å‡†åŒ–APIè°ƒç”¨
- **æ™ºèƒ½è·¯ç”±**ï¼š`/api/ai/*` è·¯å¾„æä¾›å®Œæ•´AIåŠŸèƒ½
- **æ¶ˆæ¯å¤„ç†å™¨**ï¼šé›†æˆAIåˆ†ç±»çš„æ¶ˆæ¯å¤„ç†ä¸­é—´ä»¶
- **é…ç½®ç®¡ç†**ï¼šå®Œæ•´çš„AIæœåŠ¡é…ç½®ç³»ç»Ÿ

### ğŸ›¡ï¸ å¢å¼ºçš„Webhookå¤„ç†
- **å®æ—¶åˆ†ç±»**ï¼šæ¶ˆæ¯æ¥æ”¶æ—¶ç«‹å³è¿›è¡ŒAIåˆ†ç±»
- **ä¼˜å…ˆçº§æ£€æµ‹**ï¼šè‡ªåŠ¨è¯†åˆ«ç´§æ€¥æ¶ˆæ¯å¹¶ä¼˜å…ˆå¤„ç†
- **é¢‘ç‡é™åˆ¶**ï¼šé˜²æ­¢æ¶ˆæ¯è½°ç‚¸ï¼Œä¿æŠ¤ç³»ç»Ÿç¨³å®šæ€§
- **é”™è¯¯æ¢å¤**ï¼šAIåˆ†ç±»å¤±è´¥æ—¶çš„ä¼˜é›…é™çº§

## ğŸ—ï¸ æ¶æ„æ›´æ–°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Bot Platforms â”‚    â”‚     Gateway     â”‚    â”‚   AI Service    â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚ â€¢ Telegram      â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â€¢ Discord       â”‚â”€â”€â”€â–¶â”‚ â”‚  Webhooks   â”‚ â”‚    â”‚ â”‚ Smart       â”‚ â”‚
â”‚ â€¢ WhatsApp      â”‚    â”‚ â”‚  Handler    â”‚ â”‚â”€â”€â”€â–¶â”‚ â”‚ Classifier  â”‚ â”‚
â”‚ â€¢ Slack         â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â€¢ Line          â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â€¢ WeWork        â”‚    â”‚ â”‚ Message     â”‚ â”‚    â”‚ â”‚ Tenant      â”‚ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ â”‚ Processor   â”‚ â”‚â”€â”€â”€â–¶â”‚ â”‚ Models      â”‚ â”‚
                       â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                       â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                       â”‚ â”‚ AI Client   â”‚ â”‚    â”‚ â”‚ Mode        â”‚ â”‚
                       â”‚ â”‚ & Routes    â”‚ â”‚â”€â”€â”€â–¶â”‚ â”‚ Manager     â”‚ â”‚
                       â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ APIæ¥å£

### æ™ºèƒ½åˆ†ç±»API

```bash
# å•æ¶ˆæ¯æ™ºèƒ½åˆ†ç±»
POST /api/ai/classify
Authorization: Bearer <token>
{
  "message": {
    "content": "æˆ‘éœ€è¦æŠ€æœ¯æ”¯æŒ",
    "platform": "discord",
    "userId": "user123"
  }
}

# å“åº”
{
  "success": true,
  "classification": {
    "category": "support",
    "confidence": 0.89,
    "mode": "training",
    "usedCustomModel": true,
    "classifier": "tenant-rule-engine"
  },
  "processingTime": 156,
  "explanation": {
    "strategy": "ä½¿ç”¨æ‚¨çš„ä¸“å±AIæ¨¡å‹è¿›è¡Œåˆ†ç±»"
  }
}
```

```bash
# æ‰¹é‡æ¶ˆæ¯åˆ†ç±»
POST /api/ai/classify/batch
Authorization: Bearer <token>
{
  "messages": [
    {"content": "è´¦æˆ·ç™»å½•é—®é¢˜", "platform": "slack"},
    {"content": "äº§å“ä»·æ ¼å’¨è¯¢", "platform": "telegram"}
  ]
}
```

### æ¨¡å¼ç®¡ç†API

```bash
# æŸ¥çœ‹å½“å‰AIæ¨¡å¼
GET /api/ai/mode
Authorization: Bearer <token>

# åˆ‡æ¢AIæ¨¡å¼
POST /api/ai/mode
Authorization: Bearer <token>
{
  "mode": "training",
  "reason": "å¸Œæœ›è·å¾—ä¸ªæ€§åŒ–AIæœåŠ¡"
}

# è·å–æ¨¡å¼æ¨è
GET /api/ai/mode/recommend
Authorization: Bearer <token>
```

### ç§Ÿæˆ·æ¨¡å‹API

```bash
# è®­ç»ƒä¸“å±æ¨¡å‹
POST /api/ai/models/train
Authorization: Bearer <token>
{
  "modelType": "rule-engine",
  "examples": [
    {"text": "ç½‘ç«™æ— æ³•è®¿é—®", "category": "technical"},
    {"text": "æƒ³è´­ä¹°VIP", "category": "sales"}
  ]
}

# æŸ¥çœ‹æ¨¡å‹åˆ—è¡¨
GET /api/ai/models
Authorization: Bearer <token>

# è·å–ç»Ÿè®¡ä¿¡æ¯
GET /api/ai/stats?timeRange=24h
Authorization: Bearer <token>
```

## ğŸ”§ é…ç½®è¯´æ˜

### Gatewayç¯å¢ƒå˜é‡
```bash
# AIæœåŠ¡é…ç½®
AI_SERVICE_URL=http://localhost:3002
AI_SERVICE_TIMEOUT=30000
AI_CLASSIFICATION_ENABLED=true
AI_BATCH_PROCESSING_ENABLED=true

# æ¶ˆæ¯å¤„ç†é…ç½®
MESSAGE_RATE_LIMIT_ENABLED=true
MESSAGE_RATE_LIMIT_PER_MINUTE=60
URGENT_MESSAGE_DETECTION=true

# ç¼“å­˜é…ç½®
AI_RESULT_CACHE_ENABLED=true
AI_RESULT_CACHE_TTL=300
```

### AIæœåŠ¡é…ç½®
```javascript
// services/gateway/src/config/aiService.js
const aiServiceConfig = {
  baseURL: 'http://localhost:3002',
  timeout: 30000,
  features: {
    smartClassification: true,
    customModels: true,
    batchProcessing: true,
    fallbackMode: true
  }
};
```

## ğŸš€ éƒ¨ç½²æ›´æ–°

### 1. æ›´æ–°Gatewayä»£ç 
```bash
cd services/gateway
npm install
```

### 2. å¯åŠ¨æœåŠ¡
```bash
# å¼€å‘ç¯å¢ƒ
npm run dev

# ç”Ÿäº§ç¯å¢ƒ
npm start
```

### 3. éªŒè¯é›†æˆ
```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:3000/health

# AIæœåŠ¡è¿é€šæ€§
curl -H "Authorization: Bearer <token>" \
     http://localhost:3000/api/ai/mode

# æµ‹è¯•åˆ†ç±»
curl -X POST \
     -H "Authorization: Bearer <token>" \
     -H "Content-Type: application/json" \
     -d '{"message":{"content":"æµ‹è¯•æ¶ˆæ¯","platform":"test"}}' \
     http://localhost:3000/api/ai/classify
```

## ğŸ“Š æ¶ˆæ¯å¤„ç†æµç¨‹

### å¢å¼ºçš„Webhookå¤„ç†

```javascript
// åŸæ¥çš„æµç¨‹
webhook â†’ ä¿å­˜æ¶ˆæ¯ â†’ å‘é€åˆ°å¤„ç†å™¨

// ç°åœ¨çš„æµç¨‹  
webhook â†’ ä¿å­˜æ¶ˆæ¯ â†’ AIåˆ†ç±» â†’ ç´§æ€¥æ£€æµ‹ â†’ å‘é€åˆ°å¤„ç†å™¨
```

### æ¶ˆæ¯å¤„ç†æ­¥éª¤

1. **æ¥æ”¶æ¶ˆæ¯**ï¼šå¹³å°webhookå‘é€æ¶ˆæ¯åˆ°Gateway
2. **é¢‘ç‡æ£€æŸ¥**ï¼šéªŒè¯å‘é€é¢‘ç‡ï¼Œé˜²æ­¢æ»¥ç”¨
3. **ä¿å­˜æ¶ˆæ¯**ï¼šå°†æ¶ˆæ¯ä¿å­˜åˆ°æ•°æ®åº“
4. **AIåˆ†ç±»**ï¼šè°ƒç”¨æ™ºèƒ½åˆ†ç±»æœåŠ¡
5. **ä¼˜å…ˆçº§åˆ¤æ–­**ï¼šæ£€æµ‹æ˜¯å¦ä¸ºç´§æ€¥æ¶ˆæ¯
6. **æ•°æ®å¢å¼º**ï¼šæ·»åŠ åˆ†ç±»å’Œä¼˜å…ˆçº§ä¿¡æ¯
7. **è½¬å‘å¤„ç†**ï¼šå‘é€åˆ°æ¶ˆæ¯å¤„ç†å™¨

### é”™è¯¯å¤„ç†å’Œå›é€€

```javascript
// AIåˆ†ç±»å¤±è´¥æ—¶çš„å›é€€ç­–ç•¥
try {
  classification = await aiClient.classifyMessage(message);
} catch (error) {
  // å›é€€åˆ°åŸºç¡€åˆ†ç±»
  classification = {
    category: 'unclassified',
    confidence: 0,
    classifier: 'fallback'
  };
}
```

## ğŸ” ç›‘æ§å’Œæ—¥å¿—

### å…³é”®æŒ‡æ ‡
- **åˆ†ç±»å‡†ç¡®ç‡**ï¼šAIåˆ†ç±»çš„å‡†ç¡®æ€§
- **å“åº”æ—¶é—´**ï¼šåˆ†ç±»å¤„ç†æ—¶é—´
- **æˆåŠŸç‡**ï¼šAIæœåŠ¡å¯ç”¨æ€§
- **æ¨¡å¼ä½¿ç”¨ç‡**ï¼šè®­ç»ƒæ¨¡å¼vsæ™®é€šæ¨¡å¼ä½¿ç”¨æ¯”ä¾‹

### æ—¥å¿—ç¤ºä¾‹
```json
{
  "level": "info",
  "message": "AI classification completed",
  "messageId": "msg_12345",
  "tenantId": "tenant_001",
  "category": "support",
  "confidence": 0.89,
  "usedCustomModel": true,
  "mode": "training",
  "processingTime": 156
}
```

## ğŸš¨ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **AIæœåŠ¡è¿æ¥å¤±è´¥**
   ```bash
   # æ£€æŸ¥AIæœåŠ¡çŠ¶æ€
   curl http://localhost:3002/health
   
   # æ£€æŸ¥ç½‘ç»œè¿æ¥
   telnet localhost 3002
   ```

2. **åˆ†ç±»å‡†ç¡®ç‡ä½**
   - æ£€æŸ¥è®­ç»ƒæ•°æ®è´¨é‡
   - éªŒè¯æ¨¡å‹é…ç½®
   - è€ƒè™‘åˆ‡æ¢æ¨¡å¼

3. **å“åº”æ—¶é—´è¿‡é•¿**
   - è°ƒæ•´è¶…æ—¶é…ç½®
   - æ£€æŸ¥æ‰¹é‡å¤„ç†è®¾ç½®
   - ä¼˜åŒ–ç¼“å­˜ç­–ç•¥

### è°ƒè¯•å‘½ä»¤
```bash
# æŸ¥çœ‹Gatewayæ—¥å¿—
tail -f logs/gateway.log

# æ£€æŸ¥AIæœåŠ¡å¥åº·çŠ¶æ€
curl http://localhost:3000/api/ai/health

# éªŒè¯é…ç½®
node -e "console.log(require('./src/config/aiService').aiServiceConfig)"
```

## ğŸ¯ ä½¿ç”¨å»ºè®®

### å¼€å‘é˜¶æ®µ
1. å¯ç”¨è¯¦ç»†æ—¥å¿—è®°å½•
2. ä½¿ç”¨é¢„è§ˆæ¨¡å¼æµ‹è¯•åˆ†ç±»
3. å…³æ³¨é”™è¯¯ç‡å’Œå“åº”æ—¶é—´

### ç”Ÿäº§éƒ¨ç½²
1. é…ç½®ç›‘æ§å‘Šè­¦
2. è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
3. å¯ç”¨ç¼“å­˜ä¼˜åŒ–æ€§èƒ½
4. å®šæœŸæ£€æŸ¥AIæœåŠ¡å¥åº·çŠ¶æ€

### æ€§èƒ½ä¼˜åŒ–
1. **æ‰¹é‡å¤„ç†**ï¼šå¯¹äºå¤§é‡æ¶ˆæ¯ä½¿ç”¨æ‰¹é‡API
2. **ç»“æœç¼“å­˜**ï¼šå¯ç”¨åˆ†ç±»ç»“æœç¼“å­˜
3. **è¿æ¥æ± **ï¼šé…ç½®åˆé€‚çš„è¿æ¥æ± å¤§å°
4. **å¼‚æ­¥å¤„ç†**ï¼šä½¿ç”¨å¼‚æ­¥æ–¹å¼å¤„ç†éç´§æ€¥æ¶ˆæ¯

---

é€šè¿‡è¿™æ¬¡å‡çº§ï¼ŒGatewayç°åœ¨æä¾›äº†å®Œæ•´çš„AIé©±åŠ¨æ¶ˆæ¯å¤„ç†èƒ½åŠ›ï¼Œæ”¯æŒåŒæ¨¡å¼åˆ‡æ¢ï¼Œç¡®ä¿åœ¨éšç§ä¿æŠ¤å’Œä¸ªæ€§åŒ–æœåŠ¡ä¹‹é—´æ‰¾åˆ°æœ€ä½³å¹³è¡¡ã€‚ğŸš€ 